<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Arrow Game - Vydra</title>
  <style>
    body {
      margin: 0;
      overflow: hidden;
      background-color: #eef;
    }

    canvas {
      position: absolute;
      top: 0;
      left: 0;
    }

    #character {
      width: 62px;
      height: 62px;
      position: absolute;
      image-rendering: pixelated;
      pointer-events: none;
      z-index: 10;
    }
  </style>
</head>
<body>

<canvas id="gameCanvas"></canvas>
<img id="character" src="Vydra/Idle/Idle00.png" alt="Vydra" />

<script>
  const TILE_SIZE = 62;
  const mapData = [
    [0, 1, 2, 1, 0],
    [1, 2, 3, 2, 1],
    [0, 1, 2, 1, 0],
    [1, 2, 3, 2, 1],
    [0, 1, 2, 1, 0],
  ];

  const canvas = document.getElementById('gameCanvas');
  const ctx = canvas.getContext('2d');
  canvas.width = mapData[0].length * TILE_SIZE;
  canvas.height = mapData.length * TILE_SIZE;

  const tileset = new Image();
  tileset.src = 'tileset.png'; // ðŸ‘ˆ tileset giáº£ láº­p

  const drawTilemap = () => {
    for (let y = 0; y < mapData.length; y++) {
      for (let x = 0; x < mapData[y].length; x++) {
        const tileID = mapData[y][x];
        ctx.drawImage(
          tileset,
          tileID * TILE_SIZE, 0, TILE_SIZE, TILE_SIZE,
          x * TILE_SIZE, y * TILE_SIZE, TILE_SIZE, TILE_SIZE
        );
      }
    }
  };

  // ----------------- Character Logic --------------------
  let pos = { top: 124, left: 124 }; // trung tÃ¢m báº£n Ä‘á»“
  let direction = '';
  let moveFrame = 0;
  let idleFrame = 0;
  let isMoving = false;
  let state = 'idle';
  let spacePressed = false;

  const character = document.getElementById('character');

  const keyToVector = {
    'ArrowUp':    { dx: 0, dy: -1, dir: 'U' },
    'ArrowDown':  { dx: 0, dy: 1, dir: '' },
    'ArrowLeft':  { dx: -1, dy: 0, dir: 'L' },
    'ArrowRight': { dx: 1, dy: 0, dir: 'R' }
  };

  const updateSprite = () => {
    const folder = state.charAt(0).toUpperCase() + state.slice(1);
    const baseName = folder + direction;
    const frameStr = (state === 'run') ? `${moveFrame % 8}` :
                     (state === 'idle' ? idleFrame : moveFrame % 16).toString().padStart(2, '0');
    character.src = `Vydra/${folder}/${baseName}${frameStr}.png`;
  };

  const moveCharacter = (dx, dy, newState, newDirection) => {
    if (isMoving) return;
    isMoving = true;
    state = newState;
    direction = newDirection;
    moveFrame = 0;

    const steps = (newState === 'run') ? 8 : 16;
    const speed = (newState === 'run') ? 25 : 30;
    const stepX = (dx * TILE_SIZE) / steps;
    const stepY = (dy * TILE_SIZE) / steps;

    let currentStep = 0;

    const step = () => {
      if (currentStep >= steps) {
        isMoving = false;
        state = 'idle';
        updateSprite();
        return;
      }
      pos.left += stepX;
      pos.top += stepY;
      character.style.left = pos.left + 'px';
      character.style.top = pos.top + 'px';
      moveFrame++;
      updateSprite();
      currentStep++;
      setTimeout(step, speed);
    };

    step();
  };

  let idleInterval;
  const startIdleLoop = () => {
    idleInterval = setInterval(() => {
      if (!isMoving && state === 'idle') {
        idleFrame = (idleFrame + 1) % 16;
        updateSprite();
      }
    }, 200);
  };

  window.addEventListener('keydown', function(e) {
    if (e.code === 'Space') {
      spacePressed = true;
    }

    if (!(e.key in keyToVector)) return;
    e.preventDefault();

    const { dx, dy, dir } = keyToVector[e.key];
    const mode = spacePressed ? 'run' : 'walk';
    moveCharacter(dx, dy, mode, dir);
  });

  window.addEventListener('keyup', function(e) {
    if (e.code === 'Space') {
      spacePressed = false;
    }
  });

  character.style.left = pos.left + 'px';
  character.style.top = pos.top + 'px';

  tileset.onload = () => {
    drawTilemap();
    preloadImages(() => {
      updateSprite();
      startIdleLoop();
    });
  };

  const preloadImages = (callback) => {
    const folders = { Idle: 16, Walk: 16, Run: 8 };
    const directions = ['', 'U', 'L', 'R'];
    let loaded = 0;
    let total = 0;

    for (const folder in folders) {
      for (const dir of directions) {
        const count = folders[folder];
        for (let i = 0; i < count; i++) {
          const frameStr = folder === 'Run' ? `${i}` : `${i.toString().padStart(2, '0')}`;
          const src = `Vydra/${folder}/${folder}${dir}${frameStr}.png`;
          const img = new Image();
          img.src = src;
          img.onload = img.onerror = () => {
            loaded++;
            if (loaded === total) callback();
          };
          total++;
        }
      }
    }
  };
</script>

</body>
</html>
