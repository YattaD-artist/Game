<script>
  let moveInterrupt = false;

  const character = document.getElementById('character');
  const frameSize = 62;
  let pos = { top: 100, left: 100 };
  let direction = '';
  let moveFrame = 0;
  let idleFrame = 0;
  let isMoving = false;
  let state = 'idle';
  let spacePressed = false;

  const keyToVector = {
    'ArrowUp':    { dx: 0, dy: -1, dir: 'U' },
    'ArrowDown':  { dx: 0, dy: 1, dir: '' },
    'ArrowLeft':  { dx: -1, dy: 0, dir: 'L' },
    'ArrowRight': { dx: 1, dy: 0, dir: 'R' }
  };

  const preloadImages = (callback) => {
    const folders = { Idle: 16, Walk: 16, Run: 8 };
    const directions = ['', 'U', 'L', 'R'];
    let loaded = 0;
    let total = 0;

    for (const folder in folders) {
      for (const dir of directions) {
        const count = folders[folder];
        for (let i = 0; i < count; i++) {
          const frameStr = folder === 'Run' ? `${i}` : `${i.toString().padStart(2, '0')}`;
          const src = `Vydra/${folder}/${folder}${dir}${frameStr}.png`;
          const img = new Image();
          img.src = src;
          img.onload = img.onerror = () => {
            loaded++;
            if (loaded === total) callback();
          };
          total++;
        }
      }
    }
  };

  const updateSprite = () => {
    const folder = state.charAt(0).toUpperCase() + state.slice(1);
    const baseName = folder + direction;
    const frameStr = (state === 'run') ? `${moveFrame % 8}` :
                     (state === 'idle' ? idleFrame : moveFrame % 16).toString().padStart(2, '0');
    character.src = `Vydra/${folder}/${baseName}${frameStr}.png`;
  };

  const moveCharacter = (dx, dy, newState, newDirection) => {
    if (isMoving) return;
    isMoving = true;
    state = newState;
    direction = newDirection;
    moveFrame = 0;

    const steps = (newState === 'run') ? 8 : 16;
    const speed = (newState === 'run') ? 25 : 20; // ðŸ‘ˆ Walk nhanh hÆ¡n 50%
    const stepX = (dx * frameSize) / steps;
    const stepY = (dy * frameSize) / steps;

    let currentStep = 0;

    const step = () => {
      if (moveInterrupt) {
        isMoving = false;
        moveInterrupt = false;
        state = 'idle';
        updateSprite();
        return;
      }

      if (currentStep >= steps) {
        isMoving = false;
        state = 'idle';
        updateSprite();
        return;
      }

      pos.left += stepX;
      pos.top += stepY;
      character.style.left = pos.left + 'px';
      character.style.top = pos.top + 'px';
      moveFrame++;
      updateSprite();
      currentStep++;
      setTimeout(step, speed);
    };

    step();
  };

  const startNewMove = (dx, dy, mode, dir) => {
    moveCharacter(dx, dy, mode, dir);
  };

  let idleInterval;
  const startIdleLoop = () => {
    idleInterval = setInterval(() => {
      if (!isMoving && state === 'idle') {
        idleFrame = (idleFrame + 1) % 16;
        updateSprite();
      }
    }, 200);
  };

  window.addEventListener('keydown', function(e) {
    if (e.code === 'Space') {
      spacePressed = true;
    }

    if (!(e.key in keyToVector)) return;
    e.preventDefault();

    const { dx, dy, dir } = keyToVector[e.key];
    const mode = spacePressed ? 'run' : 'walk';

    if (isMoving) {
      moveInterrupt = true;
      setTimeout(() => {
        startNewMove(dx, dy, mode, dir);
      }, 10);
    } else {
      moveCharacter(dx, dy, mode, dir);
    }
  });

  window.addEventListener('keyup', function(e) {
    if (e.code === 'Space') {
      spacePressed = false;
    }
  });

  character.style.left = pos.left + 'px';
  character.style.top = pos.top + 'px';

  preloadImages(() => {
    updateSprite();
    startIdleLoop();
  });
</script>
